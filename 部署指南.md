# Vue + Django 博客项目阿里云部署指南

## 本地项目问题检查

### 发现的问题
1. **缺少requirements.txt文件** - Python依赖没有导出，部署时需要
2. **数据库用户配置** - 当前使用"readonly"用户，生产环境需要适当权限
3. **环境变量依赖** - 多个环境变量未设置，部署前需配置
4. **前端生产配置** - Vite配置缺少生产环境优化设置

### 部署前准备工作
1. 导出Python依赖
2. 创建环境变量配置文件
3. 优化前端构建配置
4. 配置生产环境数据库设置

## 阿里云部署详细指南

### 一、服务器购买与基础配置

#### 1.1 购买ECS云服务器
- **推荐配置**：2核4G，40GB SSD，Ubuntu 20.04 LTS
- **带宽选择**：3Mbps按量付费（可后续调整）
- **安全组配置**：
  - SSH: 22端口
  - HTTP: 80端口
  - HTTPS: 443端口
  - 自定义TCP: 8000端口（Django开发调试用）

#### 1.2 域名解析配置
```bash
# 在阿里云域名解析控制台添加记录
@ A 服务器IP地址
www A 服务器IP地址
```

#### 1.3 服务器基础环境安装
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础软件
sudo apt install -y git curl wget vim nginx python3 python3-pip python3-venv

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装MySQL（可选，也可使用RDS）
sudo apt install -y mysql-server

# 安装Redis（缓存和会话存储）
sudo apt install -y redis-server

# 安装 Supervisor（进程管理）
sudo apt install -y supervisor
```

### 二、数据库配置

#### 2.1 本地MySQL配置（不使用RDS的情况）
```bash
# 安全配置MySQL
sudo mysql_secure_installation

# 登录MySQL创建数据库
sudo mysql -u root -p
```

```sql
CREATE DATABASE blog CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'bloguser'@'localhost' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON blog.* TO 'bloguser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 2.2 RDS配置（推荐）
- 在阿里云控制台创建RDS MySQL实例
- 设置白名单（添加ECS内网IP）
- 创建数据库和用户
- 记录连接信息（内网地址、端口、用户名、密码）

### 三、项目部署

#### 3.1 创建项目目录和用户
```bash
# 创建部署用户
sudo useradd -m -s /bin/bash deploy
sudo usermod -aG sudo deploy

# 切换到deploy用户
sudo su - deploy

# 创建项目目录
mkdir -p /home/deploy/blog
cd /home/deploy/blog
```

#### 3.2 克隆项目代码
```bash
# 克隆代码（替换为你的仓库地址）
git clone https://github.com/yourusername/blog.git .

# 或者使用SCP上传代码包
# scp -r /path/to/local/blog deploy@server_ip:/home/deploy/
```

#### 3.3 Python环境配置
```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖（需要先创建requirements.txt）
pip install -r requirements.txt

# 安装生产服务器相关包
pip install gunicorn psycopg2-binary
```

#### 3.4 创建requirements.txt（在本地执行）
```bash
# 在本地项目目录执行
.venv\Scripts\activate
pip freeze > requirements.txt
```

#### 3.5 环境变量配置
```bash
# 创建环境变量文件
vim /home/deploy/blog/.env
```

```bash
# Django配置
SECRET_KEY=your_very_long_secret_key_here
DEBUG=False
ALLOWED_HOSTS=your_domain.com,www.your_domain.com,server_ip

# 数据库配置
MYSQL_PASSWORD=your_database_password
DB_NAME=blog
DB_USER=bloguser
DB_HOST=localhost  # 或RDS内网地址
DB_PORT=3306

# 邮件配置
DEFAULT_FROM_EMAIL=your_email@qq.com
QQ_EMAIL_HOST_PASSWORD=your_qq_email_smtp_password
```

#### 3.6 修改Django设置
```bash
# 修改settings.py，添加环境变量读取
vim backend/settings.py
```

```python
import os
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
load_dotenv(os.path.join(BASE_DIR, '.env'))

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.environ.get('DB_NAME', 'blog'),
        'USER': os.environ.get('DB_USER', 'bloguser'),
        'PASSWORD': os.environ.get('MYSQL_PASSWORD'),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '3306'),
    }
}

# 生产环境配置
DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'
ALLOWED_HOSTS = os.environ.get('ALLOWED_HOSTS', '').split(',')
```

#### 3.7 数据库迁移
```bash
# 激活虚拟环境
source venv/bin/activate

# 执行数据库迁移
python manage.py makemigrations
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 创建初始数据
python manage.py create_category_tags

# 收集静态文件
python manage.py collectstatic --noinput
```

#### 3.8 前端构建
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 修改生产环境API地址
vim src/services/api.js
# 将baseURL改为生产环境地址或相对路径

# 构建生产版本
npm run build

# 复制构建文件到Django静态文件目录
cp -r dist/* ../static/
```

### 四、Web服务器配置

#### 4.1 Nginx配置
```bash
# 创建Nginx配置文件
sudo vim /etc/nginx/sites-available/blog
```

```nginx
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;

    # 前端静态文件
    location / {
        root /home/deploy/blog/static;
        try_files $uri $uri/ /index.html;
    }

    # Django API
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 媒体文件
    location /media/ {
        alias /home/deploy/blog/media/;
    }

    # 静态文件
    location /static/ {
        alias /home/deploy/blog/static/;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/blog /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

#### 4.2 Gunicorn配置
```bash
# 创建Gunicorn配置文件
vim /home/deploy/blog/gunicorn.conf.py
```

```python
bind = "127.0.0.1:8000"
workers = 3
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100
preload_app = True
```

#### 4.3 Supervisor进程管理
```bash
# 创建Supervisor配置文件
sudo vim /etc/supervisor/conf.d/blog.conf
```

```ini
[program:blog]
command=/home/deploy/blog/venv/bin/gunicorn -c gunicorn.conf.py blog.wsgi:application
directory=/home/deploy/blog
user=deploy
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/blog.log
```

```bash
# 重新加载Supervisor配置
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start blog
```

### 五、SSL证书配置

#### 5.1 安装Certbot
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your_domain.com -d www.your_domain.com
```

#### 5.2 自动续期
```bash
# 测试自动续期
sudo certbot renew --dry-run

# 添加定时任务
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 六、生产环境优化

#### 6.1 数据库优化
```sql
-- MySQL性能优化配置
SET GLOBAL innodb_buffer_pool_size = 1073741824;  -- 1GB
SET GLOBAL innodb_log_file_size = 268435456;      -- 256MB
SET GLOBAL max_connections = 200;
```

#### 6.2 Redis缓存配置
```bash
# 配置Redis
sudo vim /etc/redis/redis.conf
# 修改以下配置：
maxmemory 256mb
maxmemory-policy allkeys-lru
```

```bash
# 重启Redis
sudo systemctl restart redis
```

#### 6.3 Django缓存配置
```python
# 在settings.py中添加缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}
```

### 七、监控与维护

#### 7.1 日志配置
```bash
# 创建日志目录
sudo mkdir -p /var/log/blog
sudo chown deploy:deploy /var/log/blog

# 配置日志轮转
sudo vim /etc/logrotate.d/blog
```

```
/var/log/blog/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 deploy deploy
    postrotate
        supervisorctl restart blog
    endscript
}
```

#### 7.2 备份策略
```bash
# 创建备份脚本
vim /home/deploy/blog/backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/home/deploy/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
mysqldump -u bloguser -p blog > $BACKUP_DIR/blog_db_$DATE.sql

# 媒体文件备份
tar -czf $BACKUP_DIR/blog_media_$DATE.tar.gz media/

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

```bash
# 添加执行权限
chmod +x backup.sh

# 添加定时任务（每天凌晨3点备份）
crontab -e
# 添加：0 3 * * * /home/deploy/blog/backup.sh
```

#### 7.3 监控脚本
```bash
# 创建监控脚本
vim /home/deploy/blog/monitor.sh
```

```bash
#!/bin/bash
# 检查服务状态
if ! supervisorctl status blog | grep RUNNING; then
    echo "Blog service is down, restarting..." | mail -s "Blog Alert" your_email@example.com
    supervisorctl restart blog
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is ${DISK_USAGE}%" | mail -s "Disk Alert" your_email@example.com
fi
```

### 八、安全加固

#### 8.1 防火墙配置
```bash
# 启用UFW防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
```

#### 8.2 SSH安全
```bash
# 修改SSH配置
sudo vim /etc/ssh/sshd_config
# 修改以下配置：
# Port 22 -> 改为其他端口
# PermitRootLogin no
# PasswordAuthentication no（使用密钥登录）

# 重启SSH服务
sudo systemctl restart ssh
```

#### 8.3 定期更新
```bash
# 创建更新脚本
vim /home/deploy/blog/update.sh
```

```bash
#!/bin/bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 更新Python依赖
source /home/deploy/blog/venv/bin/activate
pip install -r /home/deploy/blog/requirements.txt --upgrade

# 重启服务
sudo supervisorctl restart blog
sudo systemctl restart nginx
```

### 九、常见问题解决

#### 9.1 502错误
- 检查Gunicorn是否运行：`supervisorctl status blog`
- 查看错误日志：`tail -f /var/log/blog.log`
- 检查端口占用：`netstat -tlnp | grep 8000`

#### 9.2 静态文件404
- 检查Nginx配置中的静态文件路径
- 确保执行了`collectstatic`命令
- 检查文件权限：`chown -R deploy:deploy static/`

#### 9.3 数据库连接失败
- 检查数据库服务状态：`sudo systemctl status mysql`
- 验证数据库用户权限
- 检查防火墙设置

### 十、性能优化建议

1. **启用Gzip压缩**：在Nginx中配置
2. **设置浏览器缓存**：静态文件长期缓存
3. **使用CDN**：静态资源加速
4. **数据库优化**：添加索引、优化查询
5. **代码优化**：减少数据库查询、使用缓存

### 十一、成本控制

1. **按需付费**：带宽和存储按实际使用量付费
2. **资源监控**：定期检查资源使用情况
3. **快照备份**：定期创建ECS快照
4. **预留实例**：长期使用可购买预留实例

## 部署检查清单

- [ ] 购买ECS实例并配置安全组
- [ ] 域名解析配置
- [ ] 服务器基础环境安装
- [ ] 数据库创建和配置
- [ ] 项目代码部署
- [ ] Python环境配置
- [ ] 环境变量配置
- [ ] 数据库迁移
- [ ] 前端构建和部署
- [ ] Nginx配置
- [ ] Gunicorn和Supervisor配置
- [ ] SSL证书安装
- [ ] 备份策略配置
- [ ] 监控和日志配置
- [ ] 安全加固
- [ ] 性能优化
- [ ] 测试所有功能

## 应急响应

1. **服务宕机**：检查Supervisor状态，重启服务
2. **数据库问题**：检查连接、权限、磁盘空间
3. **被攻击**：查看日志、封禁IP、加强安全
4. **数据丢失**：从备份恢复

---

**注意事项**：
- 部署前务必在本地充分测试
- 生产环境不要使用DEBUG=True
- 定期备份数据和配置
- 保持系统和依赖更新
- 监控服务器性能和安全